# Apache sites-available sample for tanuh.ai/bc-screener-research
# Purpose: Expose the SPA running in Docker (mapped to host port 8080) at the
#          path /bc-screener-research on tanuh.ai for both HTTP and HTTPS.
#
# How to use on Ubuntu/Debian with Apache 2.4:
#   sudo a2enmod proxy proxy_http headers rewrite ssl
#   # If you expect WebSockets, also:
#   # sudo a2enmod proxy_wstunnel
#   sudo mkdir -p /etc/apache2/sites-available
#   sudo cp bc-screener-research.conf /etc/apache2/sites-available/
#   sudo a2ensite bc-screener-research
#   sudo systemctl reload apache2
#
# Notes:
# - This config assumes your Docker Compose maps the container to host port 8080:
#     services.web.ports: - "8080:80"
#   Adjust the ProxyPass target if your port differs.
# - The SPA is already configured to handle client-side routing at the backend
#   via .htaccess inside the container. We proxy all requests under the prefix.
# - If tanuh.ai already has another vhost, merge the <Location> section below
#   into that site instead of using a separate vhost file.

# Optional: If you have multiple hostnames, add ServerAlias lines as needed.
# Replace with your real admin email if you want.

######################################################################
# HTTP (non-SSL)
######################################################################
<VirtualHost *:80>
  ServerName tanuh.ai
  #ServerAlias www.tanuh.ai
  ServerAdmin ashwin.mecon@gmail.com

  # If you prefer strict HTTPS, uncomment to redirect everything to HTTPS.
  # Keep ACME challenge reachable over HTTP if using certbot.
  #RewriteEngine On
  #RewriteCond %{REQUEST_URI} !^/.well-known/acme-challenge/
  #RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

  # Let Apache accept encoded slashes and pass them as-is to the backend,
  # useful for SPA routes and asset paths with URL-encoded characters.
  AllowEncodedSlashes NoDecode

  # Ensure a trailing slash exists for the mount point to avoid double-proxying
  # the path-less variant. This makes relative asset URLs behave predictably.
  RedirectMatch 302 ^/bc-screener-research$ /bc-screener-research/

  # Forwarded headers to help the app know original scheme/host.
  RequestHeader set X-Forwarded-Proto "http"
  RequestHeader set X-Forwarded-Host "tanuh.ai"

  # Path-based reverse proxy to the Docker app on localhost:8080
  <Location "/bc-screener-research/">
    ProxyPreserveHost On
    ProxyPass        http://127.0.0.1:8080/ connectiontimeout=5 timeout=60 keepalive=On
    ProxyPassReverse http://127.0.0.1:8080/

    # If your app sets cookies without a path/domain, these can help when mounted under a subpath
    ProxyPassReverseCookiePath / /bc-screener-research/
    ProxyPassReverseCookieDomain 127.0.0.1 tanuh.ai

    # For WebSockets (if ever used by the app), uncomment the next two lines
    #ProxyPassMatch  
    #  ^/bc-screener-research/(.*) ws://127.0.0.1:8080/$1
  </Location>

  # Basic logs
  ErrorLog  ${APACHE_LOG_DIR}/bc-screener-research-error.log
  CustomLog ${APACHE_LOG_DIR}/bc-screener-research-access.log combined
</VirtualHost>

######################################################################
# HTTPS (SSL)
######################################################################
<VirtualHost *:443>
  ServerName tanuh.ai
  #ServerAlias www.tanuh.ai
  ServerAdmin ashwin.mecon@gmail.com

  SSLEngine on
  # Replace with your real certificate paths (e.g., from certbot)
  SSLCertificateFile      /etc/letsencrypt/live/tanuh.ai/fullchain.pem
  SSLCertificateKeyFile   /etc/letsencrypt/live/tanuh.ai/privkey.pem
  # If provided by your CA
  #SSLCertificateChainFile /etc/letsencrypt/live/tanuh.ai/chain.pem

  # Security headers (adjust to your needs)
  Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains" env=HTTPS
  Header always set X-Content-Type-Options nosniff
  Header always set X-Frame-Options SAMEORIGIN
  Header always set Referrer-Policy no-referrer-when-downgrade
  Header always set X-XSS-Protection "1; mode=block"

  AllowEncodedSlashes NoDecode

  # Normalize missing trailing slash to reduce redirect hops from the backend
  RedirectMatch 302 ^/bc-screener-research$ /bc-screener-research/

  # Forwarded headers to help the app know original scheme/host.
  RequestHeader set X-Forwarded-Proto "https"
  RequestHeader set X-Forwarded-Host  "tanuh.ai"

  <Location "/bc-screener-research/">
    ProxyPreserveHost On
    ProxyPass        http://127.0.0.1:8080/ connectiontimeout=5 timeout=60 keepalive=On
    ProxyPassReverse http://127.0.0.1:8080/

    ProxyPassReverseCookiePath / /bc-screener-research/
    ProxyPassReverseCookieDomain 127.0.0.1 tanuh.ai

    # WebSockets (if used)
    #ProxyPassMatch  
    #  ^/bc-screener-research/(.*) ws://127.0.0.1:8080/$1
  </Location>

  ErrorLog  ${APACHE_LOG_DIR}/bc-screener-research-ssl-error.log
  CustomLog ${APACHE_LOG_DIR}/bc-screener-research-ssl-access.log combined
</VirtualHost>
